<modification>
	<id><![CDATA[Litemf]]></id>
	<version><![CDATA[1.0.0]]></version>
	<name>Litemf</name>
	<code>Litemf</code>
	<vqmver><![CDATA[2.1.6]]></vqmver>
	<author><![CDATA[Mihail Bogdanov]]></author>
	<file path="catalog/view/theme/*/template/checkout/shipping_method.tpl">
		<operation error="skip">
			<search><![CDATA[<div class="alert alert-danger"><?php echo $shipping_method['error']; ?></div>]]></search>
			<add position="after" offset="3"><![CDATA[
				<style>
					@keyframes spinner {
					to {transform: rotate(360deg);}
					}
					@-webkit-keyframes spinner {
					to {-webkit-transform: rotate(360deg);}
					}
					.spinner {
						min-width: 24px;
						min-height: 24px;
					}
					.spinner:before {
						content: 'Loading…';
						position: absolute;
						top: 50%;
						left: 50%;
						width: 16px;
						height: 16px;
						margin-top: -10px;
						margin-left: -10px;
					}
					.spinner:not(:required):before {
						content: '';
						border-radius: 50%;
						border: 2px solid rgba(0, 0, 0, .3);
						border-top-color: rgba(0, 0, 0, .6);
						animation: spinner .6s linear infinite;
						-webkit-animation: spinner .6s linear infinite;
					}
				</style>
				<div id="shiptor_delivery_block">
				  <div class="row">
					  	<div class="col-md-offset-1 col-md-9">
							<p><input type="checkbox" id="check_passport" name="passport">Заполнить паспортные данные заранее?</p>
					  	</div>
					  <div class="col-md-12" id="litemf_passport" style="display:none">
					  	<h4>Паспортные данные</h4>
						<div class="col-sm-6">
							<div class="form-group required">
								<label class="control-label" for="input-litemf-first_name">Имя</label>
								<input type="text" name="litemf[first_name]" id="input-litemf-first_name" pattern="[A-Za-zА-Яа-яЁё]" data-error="Имя должно быть от 1 до 32 символов!" class="form-control">
							</div>
							<div class="form-group required">
								<label class="control-label" for="input-litemf-last_name">Фамилия</label>
								<input type="text" name="litemf[last_name]" id="input-litemf-last_name" pattern="[A-Za-zА-Яа-яЁё]" data-error="Фамилия должна быть от 1 до 32 символов!"  class="form-control">
							</div>
							<div class="form-group">
								<label class="control-label" for="input-litemf-middle_name">Отчество</label>
								<input type="text" name="litemf[middle_name]" id="input-litemf-middle_name" class="form-control">
							</div>
							<div class="form-group required">
								<label class="control-label" for="input-litemf-phone">Телефон</label>
								<input type="text" name="litemf[phone]" id="input-litemf-phone" pattern="(\+?\d[- .]*){7,13}" data-error="Номер телефона должен быть от 3 до 13 символов!" class="form-control">
							</div>
							<div class="form-group required">
								<label class="control-label" for="input-litemf-region">Регион</label>
								<input type="text" name="litemf[region]" id="input-litemf-region" pattern="[ a-zA-ZА-Яа-яЁё0-9,#.-]+" data-error="Регион должен быть от 3 до 64 символов!" class="form-control">
							</div>
							<div class="form-group required">
								<label class="control-label" for="input-litemf-city">Город</label>
								<input type="text" name="litemf[city]" id="input-litemf-city" pattern="[ a-zA-ZА-Яа-яЁё0-9,#.-]+"  data-error="Город должен быть от 3 до 64 символов!" class="form-control">
							</div>
							<div class="form-group required">
								<label class="control-label" for="input-litemf-zip_code">Индекс</label>
								<input type="text" name="litemf[zip_code]" id="input-litemf-zip_code" pattern="[0-9]{6}"  data-error="Индекс должен быть 6 символов!" class="form-control">
							</div>
						</div>
						<div class="col-sm-6">
							<div class="form-group required">
								<label class="control-label" for="input-litemf-street">Улица</label>
								<input type="text" name="litemf[street]" id="input-litemf-street" pattern="[ a-zA-ZА-Яа-яЁё0-9,#.-]+" data-error="Улица должна быть от 3 до 64 символов!" class="form-control">
							</div>
							<div class="form-group required">
								<label class="control-label" for="input-litemf-house">Дом</label>
								<input type="text" name="litemf[house]" id="input-litemf-house" pattern="[ a-zA-ZА-Яа-яЁё0-9,#.-]+" data-error="Дом должен быть от 1 до 10 символов!" class="form-control">
							</div>
							<div class="form-group required">
								<label class="control-label" for="input-litemf-series">Серия</label>
								<input type="text" name="litemf[series]" id="input-litemf-series" pattern="[0-9]{1,6}"  data-error="Серия должна быть от 2 до 6 символов!" class="form-control">
							</div>
							<div class="form-group required">
								<label class="control-label" for="input-litemf-number">Номер</label>
								<input type="text" name="litemf[number]" id="input-litemf-number" pattern="[0-9]{1,6}" data-error="Номер должен быть от 2 до 6 символов!" class="form-control">
							</div>
							<div class="form-group required">
								<label class="control-label" for="input-litemf-issue_date">Когда выдан</label>
								<input type="text" name="litemf[issue_date]" id="input-litemf-issue_date" placeholder="22.05.2003" pattern="[0-9]{2}\.[0-9]{2}\.[0-9]{4}" data-error="Дата не верного формата!" class="form-control">
							</div>
							<div class="form-group required">
								<label class="control-label" for="input-litemf-issued_by">Кем выдан</label>
								<input type="text" name="litemf[issued_by]" id="input-litemf-issued_by" class="form-control" pattern="[ a-zA-ZА-Яа-яЁё0-9,#.-]+" data-error="Поле должно быть от 3 до 64 символов!">
							</div>
							<input type="hidden" name="litemf[delivery_method_id]">
							<input type="hidden" name="litemf[delivery_point_id]">
							<input type="hidden" name="litemf[kladr]">
						</div>
					  </div>
				  </div>
				  	<div class="row">
						<div class="col-md-4 list-group">
						<div id="loader" class="spinner" style="display:none"></div>
						<div id="courier-price" style="overflow-y: auto;padding-left: 30px;max-height: 400px;position: relative;display:none;"></div>
						<div id="point-select" class="scroll-container" style="overflow-y: auto;padding-left: 30px;max-height: 400px;display:none;"></div>
						</div>
						<div id="YMapsID" style="height: 400px; display:none" class="col-md-8"></div>
					</div>
					<div class="row" id="courier-field" style="display:none;">
						<div class="col-sm-6">
							<div class="form-group required">
								<label class="control-label" for="input-litemf-courier-street">Улица</label>
								<input type="text" name="courier[street]" id="input-litemf-courier-street" pattern="[ a-zA-ZА-Яа-яЁё0-9,#.-]+" class="form-control" data-error="Улица должна быть от 3 до 64 символов!">
							</div>
							<div class="form-group required">
								<label class="control-label" for="input-litemf-courier-email">E-Mail</label>
								<input type="text" name="courier[email]" id="input-litemf-courier-email" pattern="[^@]+@[^@]+\.[a-zA-Z]{2,6}" class="form-control" data-error="Е-mail адрес введён неверно!">
							</div>
						</div>
						<div class="col-sm-6">
							<div class="col-sm-6">
								<div class="form-group required">
									<label class="control-label" for="input-litemf-courier-house">Дом</label>
									<input type="text" name="courier[house]" id="input-litemf-courier-house" pattern="[ a-zA-ZА-Яа-яЁё0-9,#.-]+" class="form-control" data-error="Дом должен быть от 1 до 10 символов!">
								</div>
							</div>
							<div class="col-sm-6">
								<div class="form-group required">
									<label class="control-label" for="input-litemf-courier-number">Квартира</label>
									<input type="text" name="courier[number]" id="input-litemf-courier-number" pattern="[ a-zA-ZА-Яа-яЁё0-9,#.-]+" class="form-control" data-error="Квартира должна быть от 1 до 10 символов!">
								</div>
							</div>
							<div class="col-sm-12">
								<div class="form-group required">
									<label class="control-label" for="input-litemf-courier-phone">Телефон</label>
									<input type="text" name="courier[phone]" id="input-litemf-courier-phone" pattern="(\+?\d[- .]*){7,13}" class="form-control" data-error="Номер телефона должен быть от 3 до 13 символов!" >
								</div>
							</div>
						</div>
					</div>
				</div>
			 ]]></add>
		</operation>
	</file>
	<file path="catalog/view/theme/*/template/checkout/checkout.tpl">
		<operation error="skip">
			<search><![CDATA[$(document).delegate('#button-shipping-method', 'click', function() {]]></search>
			<add position="after"><![CDATA[
				if ( $('#check_passport').is( ":checked" )) {
					var inputs = $('input[name*="litemf"]');
					var status = true;
					$.each(inputs, function( index, value ) {
						var pattern = new RegExp(value.getAttribute( 'pattern' ));
						if (value.getAttribute( 'pattern' ) != null) {
							var result = pattern.test(value.value);
							$(value).parent().find('.text-danger').remove();
							if (!result) {
								$(value).parent().append('<div class="text-danger">' + $(value).data('error') + '</div>');
								status = false
							}
						}
					});
					if (!status) {
						return false;
					}
				}
				if ($('#method-courier').is( ":checked" )) {
					var inputCourier = $('input[name*="courier"]');
					var statusCourier = true;
					$.each(inputCourier, function( index, value ) {
						var pattern = new RegExp(value.getAttribute( 'pattern' ));
						if (value.getAttribute( 'pattern' ) != null) {
							var result = pattern.test(value.value);
							$(value).parent().find('.text-danger').remove();
							if (!result) {
								$(value).parent().append('<div class="text-danger">' + $(value).data('error') + '</div>');
								statusCourier = false
							}
						}

					});
					if (!statusCourier) {
						return false;
					}
				}
			]]></add>
		</operation>
		<operation error="skip">
			<search><![CDATA[data: $('#collapse-shipping-method input[type=\'radio\']:checked, #collapse-shipping-method textarea'),]]></search>
			<add position="replace"><![CDATA[
				        data: $('#collapse-shipping-method input[type=\'radio\']:checked, #collapse-shipping-method textarea, input[name*="litemf"], input[name*="point"][type=\'radio\']:checked'),
			]]></add>
		</operation>
	</file>
	<file path="catalog/controller/checkout/shipping_method.php">
		<operation>
			<search><![CDATA[$this->response->addHeader('Content-Type: application/json');]]></search>
			<add position="before"><![CDATA[
				$shiptorMethod =  explode(".", $this->request->post['shipping_method']);
				if ($shiptorMethod[0] == 'litemf_delivery' && isset($this->request->post['point'])) {
					$this->session->data['shipping_method']['cost'] = round($this->request->post['point'],2);
					$this->session->data['shipping_method']['text'] = $this->currency->format($this->request->post['point'], $this->config->get('config_currency'));
					$this->session->data['litemf'] = $this->request->post['litemf'];
					if (isset($this->request->post['courier'])) {
						$this->session->data['courier'] = $this->request->post['courier'];
					}
				} elseif ($shiptorMethod[0] == 'litemf_delivery' && !isset($this->request->post['point'])) {
					$this->session->data['litemf'] = $this->request->post['litemf'];
					$this->session->data['courier'] = $this->request->post['courier'];
				}
			]]></add>
		</operation>
	</file>
	<file path="catalog/controller/checkout/confirm.php">
		<operation>
			<search><![CDATA[$this->session->data['order_id'] = $this->model_checkout_order->addOrder($order_data);]]></search>
			<add position="after"><![CDATA[
				if (isset($this->session->data['shipping_method'])) {
					$shiptorMethod =  explode(".", $this->session->data['shipping_method']['code']);
					if ($shiptorMethod[0] == 'litemf_delivery') {
						$litemf_data = [];
						if (isset($this->session->data['order_id'])) {
							$litemf_data['order_id'] = $this->session->data['order_id'];
						}
						$litemf_data['user_id'] = $order_data['customer_id'];
						if (isset($this->session->data['litemf'])) {
							$litemf_data['passport'] = $this->session->data['litemf'];
						}
						if (isset($this->session->data['courier'])) {
							$litemf_data['courier'] = $this->session->data['courier'];
						}
						$this->load->model('shipping/litemf_delivery');
						$this->model_shipping_litemf_delivery->addOrderLitemf($litemf_data);
					}
				}
			]]></add>
		</operation>
	</file>
	<file path="catalog/view/theme/*/template/common/header.tpl">
		<operation>
			<search><![CDATA[</head>]]></search>
			<add position="before"><![CDATA[
			<link href="https://cdn.jsdelivr.net/jquery.suggestions/16.5.2/css/suggestions.css" type="text/css" rel="stylesheet" />
			<script type="text/javascript" src="https://cdn.jsdelivr.net/jquery.suggestions/16.5.2/js/jquery.suggestions.min.js"></script>
			<script src="http://api-maps.yandex.ru/2.0/?load=package.full&lang=ru-RU&mode=debug" type="text/javascript"></script>
			<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-scrollTo/2.1.2/jquery.scrollTo.min.js" type="text/javascript"></script>
			]]></add>
		</operation>
	</file>
	<file path="catalog/view/theme/*/template/checkout/shipping_method.tpl">
		<operation>
			<search><![CDATA[<div class="buttons">]]></search>
			<add position="after" offset="5"><![CDATA[
			<script type="text/javascript">
				var shippingMethods = $('input[type=radio][name=shipping_method]');
				var map;
				var myCollection;
				function createMap() {
					ymaps.ready(function () {
						map = new ymaps.Map('YMapsID', {
							center: [55.7336, 37.581559],
							zoom: 7,
							type: 'yandex#map',
							behaviors: ['default', 'scrollZoom']
						});
						//Добавляем элементы управления
						map.controls
								.add('zoomControl')
								.add('typeSelector')
								.add('mapTools');
						myCollection = new ymaps.GeoObjectCollection();
					});
				}

                function do_search(item){
                		var gps = item.gps.split(',')
						var placemark = new ymaps.Placemark([gps[0],gps[1]], {
							//iconContent: item.id,
							balloonContentHeader: '<div>'+item.name+'</div>'
							/*balloonContentBody: '<div style="font-size:13px;"><div><strong>Адрес:</strong> '+item.address+'<br>'
							+'<strong>Стоимость доставки:</strong> '+item.price+'<br>'
							+'<strong>Режим работы:</strong> '+item.work_schedule+'<br>'
							+'<strong>Телефон:</strong> '+item.phone+'<br>'
							+'<strong>Описание:</strong> '+item.trip_description+'<br></div></div>'*/

						}, {
							// Опции
							preset: "islands#blueCircleDotIcon",
                    		iconColor: '#1faee9',
                    		balloonCloseButton: false,
                    		hideIconOnBalloonOpen: false,
						});
						placemark.events.add('click', function(e) {
							var label = $('#pvz_label_' + item.id);
							label.prop("checked", true);
							$('#point-select').scrollTo(label.parents('.list-group-item'), 300);
						});
						myCollection.add(placemark);
                        map.geoObjects.add(myCollection);
                        map.setBounds(myCollection.getBounds());
                        //map.setZoom(11, {duration: 1000});
                        map.setZoom(12, {checkZoomRange: true});
                }


                function go_to(iwslat,iwslon,iwsadr){
                    map.setCenter([iwslon,iwslat], 12);

                    myCollection.each(function (item) {
                        if (item.properties.get('balloonContentHeader') == '<div>'+iwsadr+'</div>') {
                            item.balloon.open();
                        }
                    });
                }

                function setTown(iwslat,iwslon){
                    map.setCenter([iwslat, iwslon], 11);
                    myCollection.removeAll();
                    return false;
                }
				 function destroyMap(){
					if($.type(map) === "object") {
						map.destroy();
					}
				}
				</script>
			<script type="text/javascript">
					function showBlockShiptor() {
						var checkedMethod = $('input[name="shipping_method"]:checked').val();
						var exploded = checkedMethod.split('.');
						if (exploded[0] == 'litemf_delivery') {
							if($('input[type=text][name="litemf[first_name]"]').val() == '') {
								$('input[type=text][name="litemf[first_name]"]').val($('input[type=text][name="firstname"]').val());
							}
							if($('input[type=text][name="litemf[last_name]"]').val() == '') {
								$('input[type=text][name="litemf[last_name]"]').val($('input[type=text][name="lastname"]').val());
							}
							if($('input[type=text][name="litemf[city]"]').val() == '') {
								$('input[type=text][name="litemf[city]"]').val($('input[type=text][name="city"]').val());
								$('input[type=text][name="litemf[city]"]').trigger('change');
							}
							if($('input[type=text][name="litemf[zip_code]"]').val() == '') {
								$('input[type=text][name="litemf[zip_code]"]').val($('input[type=text][name="postcode"]').val());
							}
							if($('input[type=text][name="litemf[region]"]').val() == '') {
								$('input[type=text][name="litemf[region]"]').val($('#input-shipping-zone option:selected').text());
							}
							if($('input[type=text][name="litemf[phone]"]').val() == '') {
								$('input[type=text][name="litemf[phone]"]').val($('input[type=text][name="telephone"]').val());
							}
							$('#shiptor_delivery_block').show();
							$('input[type=hidden][name="litemf[delivery_method_id]"]').val($('input[name="shipping_method"]:checked').data('id'));
							if ($('input[name="shipping_method"]:checked').data('category') == 'courier') {
								$('#point-select').hide();
								$('#courier-price').find('input').prop("checked", true);
								$('input[type=hidden][name="litemf[delivery_point_id]"]').val('courier');
								$('#courier-field').show();
								$('#point-select').hide();
								$('#YMapsID').hide();
							}
							if ($('input[name="shipping_method"]:checked').data('category') == 'terminal') {
								getDeliveryPoints($('input[type=text][name="litemf[city]"]').val(), $('input[name="shipping_method"]:checked').data('id'));
								$('#point-select').show();
								$('#YMapsID').show();
								$('#courier-price').hide();
								$('#courier-field').hide();
							}
						} else {
							$('#shiptor_delivery_block').hide();
						}
					};
				  $.ajax({
					url: 'index.php?route=checkout/litemf/getDeliveryMethod',
					dataType: 'json',
					success: function (json) {
					  console.log(json)
					  $.each(json.result.data, function( index, value ) {
					  	 $.each(shippingMethods, function() {
							  var explodedMethod = this.value.split('.');
							  if (explodedMethod[0] == 'litemf_delivery') {
								  var explodedMethodId = explodedMethod[1].split('_');
								  if (explodedMethodId[2] == value.id) {
									  $(this).attr('data-category', value.delivery_type);
									  $(this).attr('data-id', value.id);
								  }
							  }
						  });
					  });
					  shippingMethods.change(function() {
						  if ($(this).is(":checked")) {
							  showBlockShiptor();
						  }
					  });
					  shippingMethods.trigger('change');

					},
					error: function (xhr, ajaxOptions, thrownError) {
					  alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
					}
				  });

			  $(document).ready(function() {
				$('#point-select').on('change', 'input[type=radio][name=point]', function() {
					if ($(this).data('point-id') != 'courier') {
						$('input[type=hidden][name="litemf[delivery_point_id]"]').val($(this).data('point-id'))
					}
				});
				$('#check_passport').change(function() {
					if ( $('#check_passport').is( ":checked" ) ) {
						$('#litemf_passport').show()
					} else {
						$('#litemf_passport').hide();
					}
				});
			  });

			   function getDeliveryPoints(city, shippingMethodId){
				  	$.ajax({
						url: 'index.php?route=checkout/litemf/getDeliveryPoints&city=' + city + '&id=' + shippingMethodId,
						dataType: 'json',
						beforeSend: function() {
							 $('#loader').show();
						},
						complete: function(){
							 $('#loader').hide();
						 },
						success: function (json) {
							 $('#point-select').text('');
						    destroyMap();
						    createMap();
						    var myGeocoder = ymaps.geocode(city, {results: 1});
							myGeocoder.then(function (res) {
				    			var firstGeoObject = res.geoObjects.get(0);
								coords = firstGeoObject.geometry.getCoordinates();
								console.log(coords[0]);
				  				setTown(coords[0], coords[1]);
				  				$.each(json, function( index, value ) {
									do_search(value);
									var gps = value.gps.split(',');
									var text = '<div class="list-group-item" style="padding-left:25px;">';
										  text += '<h4 class="list-group-item-heading"><input type="radio" name="point" value="' + value.cost + '" data-point-id="' + value.id + '" id="pvz_label_' + value.id + '" onClick="return go_to('+gps[0]+', '+gps[1]+',\''+value.name+'\');"><span class="badge">Цена: ' + value.price + '</span> ' + value.name + '</h4>';
										  text += '<span>' + value.phone + '</span>';
										  text += '<p class="list-group-item-text">' + value.address + '</p>';
										  text += '<p class="list-group-item-text">' + value.work_schedule + '</p></div>';
									$('#point-select').append(text);
								});
							});
						},
						error: function (xhr, ajaxOptions, thrownError) {
						  alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
						}
					});
				  }
			</script>]]></add>
		</operation>
	</file>
	<file path="catalog/view/theme/*/template/checkout/simplecheckout_shipping.tpl">
		<operation error="skip">
			<search><![CDATA[<div class="simplecheckout-warning-text"><?php echo $error_no_shipping; ?></div>]]></search>
			<add position="after" offset="5"><![CDATA[
			<style>
			  @keyframes spinner {
					to {transform: rotate(360deg);}
				}

				@-webkit-keyframes spinner {
					to {-webkit-transform: rotate(360deg);}
				}

				.spinner {
					min-width: 24px;
					min-height: 24px;
				}

				.spinner:before {
					content: 'Loading…';
					position: absolute;
					top: 50%;
					left: 50%;
					width: 16px;
					height: 16px;
					margin-top: -10px;
					margin-left: -10px;
				}

				.spinner:not(:required):before {
					content: '';
					border-radius: 50%;
					border: 2px solid rgba(0, 0, 0, .3);
					border-top-color: rgba(0, 0, 0, .6);
					animation: spinner .6s linear infinite;
					-webkit-animation: spinner .6s linear infinite;
				}
			  </style>
				  <div class="row">
					  	<div class="col-md-offset-1 col-md-9">
							<p><input type="checkbox" id="check_passport" name="litemf[passport]">Заполнить паспортные данные заранее?</p>
					  	</div>
					  <div class="col-md-12" id="litemf_passport" style="display:none">
					  	<h4>Паспортные данные</h4>
						<div class="col-sm-6">
							<div class="form-group required">
								<label class="control-label" for="input-litemf-first_name">Имя</label>
								<input type="text" name="litemf[first_name]" value="<?php if (isset($litemf)) echo $litemf['first_name']; ?>" id="input-litemf-first_name" pattern="[A-Za-zА-Яа-яЁё]" data-error="Имя должно быть от 1 до 32 символов!" class="form-control">
							</div>
							<div class="form-group required">
								<label class="control-label" for="input-litemf-last_name">Фамилия</label>
								<input type="text" name="litemf[last_name]" value="<?php if (isset($litemf)) echo $litemf['last_name']; ?>" id="input-litemf-last_name" pattern="[A-Za-zА-Яа-яЁё]" data-error="Фамилия должна быть от 1 до 32 символов!"  class="form-control">
							</div>
							<div class="form-group">
								<label class="control-label" for="input-litemf-middle_name">Отчество</label>
								<input type="text" name="litemf[middle_name]" value="<?php if (isset($litemf)) echo $litemf['middle_name']; ?>" id="input-litemf-middle_name" class="form-control">
							</div>
							<div class="form-group required">
								<label class="control-label" for="input-litemf-phone">Телефон</label>
								<input type="text" name="litemf[phone]" value="<?php if (isset($litemf)) echo $litemf['phone']; ?>"  id="input-litemf-phone" pattern="(\+?\d[- .]*){7,13}" data-error="Номер телефона должен быть от 3 до 13 символов!" class="form-control">
							</div>
							<div class="form-group required hidden">
								<label class="control-label" for="input-litemf-region">Регион</label>
								<input type="text" name="litemf[region]" value="111" id="input-litemf-region" class="form-control">
							</div>
							<div class="form-group required">
								<label class="control-label" for="input-litemf-city">Город</label>
								<input type="text" name="litemf[city]" value="<?php if (isset($litemf)) echo $litemf['city']; ?>" id="input-litemf-city" pattern="[ a-zA-ZА-Яа-яЁё0-9,#.-]+"  data-error="Город должен быть 6 символов!" class="form-control">
							</div>
							<div class="form-group required hidden">
								<label class="control-label" for="input-litemf-zip_code">Индекс</label>
								<input type="text" name="litemf[zip_code]" value="111" id="input-litemf-zip_code" class="form-control">
							</div>
						</div>
						<div class="col-sm-6">
							<div class="form-group required hidden">
								<label class="control-label" for="input-litemf-street">Улица</label>
								<input type="text" name="litemf[street]" value="111" id="input-litemf-street" class="form-control">
							</div>
							<div class="form-group required hidden">
								<label class="control-label" for="input-litemf-house">Дом</label>
								<input type="text" name="litemf[house]" value="111" id="input-litemf-house" class="form-control">
							</div>
							<div class="form-group required">
								<label class="control-label" for="input-litemf-series">Серия</label>
								<input type="text" name="litemf[series]" value="<?php if (isset($litemf)) echo $litemf['series']; ?>" id="input-litemf-series" pattern="[0-9]{1,6}"  data-error="Серия должна быть от 2 до 6 символов!" class="form-control">
							</div>
							<div class="form-group required">
								<label class="control-label" for="input-litemf-number">Номер</label>
								<input type="text" name="litemf[number]" value="<?php if (isset($litemf)) echo $litemf['number']; ?>" id="input-litemf-number" pattern="[0-9]{1,6}" data-error="Номер должен быть от 2 до 6 символов!" class="form-control">
							</div>
							<div class="form-group required">
								<label class="control-label" for="input-litemf-issue_date">Когда выдан</label>
								<input type="text" name="litemf[issue_date]" value="<?php if (isset($litemf)) echo $litemf['issue_date']; ?>" id="input-litemf-issue_date" placeholder="22.05.2003" pattern="[0-9]{2}\.[0-9]{2}\.[0-9]{4}" data-error="Дата не верного формата!" class="form-control">
							</div>
							<div class="form-group required">
								<label class="control-label" for="input-litemf-issued_by">Кем выдан</label>
								<input type="text" name="litemf[issued_by]" value="<?php if (isset($litemf)) echo $litemf['issued_by']; ?>" id="input-litemf-issued_by" class="form-control" pattern="[ a-zA-ZА-Яа-яЁё0-9,#.-]+" data-error="Поле должно быть от 3 до 64 символов!">
							</div>
							<input type="hidden" name="litemf[delivery_method_id]" value="<?php if (isset($litemf)) echo $litemf['delivery_method_id']; ?>">
							<input type="hidden" name="litemf[delivery_point_id]" value="<?php if (isset($litemf)) echo $litemf['delivery_point_id']; ?>">
							<input type="hidden" name="litemf[kladr]" value="<?php if (isset($litemf)) echo $litemf['kladr']; ?>">
						</div>
					  </div>
				  </div>
				  	<div class="row">
						<div class="col-md-4 list-group">
						<div id="loader" class="spinner" style="display:none"></div>
						<div id="courier-price" style="overflow-y: auto;padding-left: 30px;max-height: 400px;position: relative;display:none;"></div>
						<div id="point-select" class="scroll-container" style="overflow-y: auto;padding-left: 30px;max-height: 400px;display:none;"></div>
						</div>
						<div id="YMapsID" style="height: 400px; display:none" class="col-md-8"></div>
					</div>
					<div class="row" id="courier-field" style="display:none;">
						<div class="col-sm-6">
							<div class="form-group required">
								<label class="control-label" for="input-litemf-courier-street">Улица</label>
								<input type="text" name="courier[street]" value="<?php if (isset($courier)) echo $courier['street']; ?>" id="input-litemf-courier-street" pattern="[ a-zA-ZА-Яа-яЁё0-9,#.-]+" class="form-control" data-error="Улица должна быть от 3 до 64 символов!">
							</div>
							<div class="form-group required">
								<label class="control-label" for="input-litemf-courier-email">E-Mail</label>
								<input type="text" name="courier[email]" value="<?php if (isset($courier)) echo $courier['email']; ?>" id="input-litemf-courier-email" pattern="[^@]+@[^@]+\.[a-zA-Z]{2,6}" class="form-control" data-error="Е-mail адрес введён неверно!">
							</div>
						</div>
						<div class="col-sm-6">
							<div class="col-sm-6">
								<div class="form-group required">
									<label class="control-label" for="input-litemf-courier-house">Дом</label>
									<input type="text" name="courier[house]" value="<?php if (isset($courier)) echo $courier['house']; ?>" id="input-litemf-courier-house" pattern="[ a-zA-ZА-Яа-яЁё0-9,#.-]+" class="form-control" data-error="Дом должен быть от 1 до 10 символов!">
								</div>
							</div>
							<div class="col-sm-6">
								<div class="form-group required">
									<label class="control-label" for="input-litemf-courier-number">Квартира</label>
									<input type="text" name="courier[number]" value="<?php if (isset($courier)) echo $courier['number']; ?>" id="input-litemf-courier-number" pattern="[ a-zA-ZА-Яа-яЁё0-9,#.-]+" class="form-control" data-error="Квартира должна быть от 1 до 10 символов!">
								</div>
							</div>
							<div class="col-sm-12">
								<div class="form-group required">
									<label class="control-label" for="input-litemf-courier-phone">Телефон</label>
									<input type="text" name="courier[phone]" value="<?php if (isset($courier)) echo $courier['phone']; ?>" id="input-litemf-courier-phone" pattern="(\+?\d[- .]*){7,13}" class="form-control" data-error="Номер телефона должен быть от 3 до 13 символов!" >
								</div>
							</div>
						</div>
					</div>
			<script type="text/javascript">
				var shippingMethods = $('input[type=radio][name=shipping_method]');
				function showBlockShiptor() {
						var checkedMethod = $('input[name="shipping_method"]:checked').val();
							if (checkedMethod != undefined) {
							var exploded = checkedMethod.split('.');
							if (exploded[0] == 'litemf_delivery') {
								if($('input[type=text][name="litemf[first_name]"]').val() == '' && $('input[type=text][name="shipping_address[firstname]"]').val() != '' && $('input[type=text][name="shipping_address[firstname]"]').val() != undefined) {
									$('input[type=text][name="litemf[first_name]"]').val($('input[type=text][name="shipping_address[firstname]"]').val());
								} else if($('input[type=text][name="litemf[first_name]"]').val() == '' && $('input[type=text][name="payment_address[firstname]"]').val() != '') {
									$('input[type=text][name="litemf[first_name]"]').val($('input[type=text][name="payment_address[firstname]"]').val());
								}
								if($('input[type=text][name="litemf[last_name]"]').val() == '' && $('input[type=text][name="shipping_address[lastname]"]').val() != '' && $('input[type=text][name="shipping_address[lastname]"]').val() != undefined) {
									$('input[type=text][name="litemf[last_name]"]').val($('input[type=text][name="shipping_address[lastname]"]').val());
								} else if($('input[type=text][name="litemf[last_name]"]').val() == '' && $('input[type=text][name="payment_address[lastname]"]').val() != '') {
									$('input[type=text][name="litemf[last_name]"]').val($('input[type=text][name="payment_address[lastname]"]').val());
								}
								if($('input[type=text][name="litemf[city]"]').val() == '' && $('input[type=text][name="shipping_address[city]"]').val() != '' && $('input[type=text][name="shipping_address[city]"]').val() != undefined) {
									$('input[type=text][name="litemf[city]"]').val($('input[type=text][name="shipping_address[city]"]').val());
								} else if($('input[type=text][name="litemf[city]"]').val() == '' && $('input[type=text][name="payment_address[city]"]').val() != '') {
									$('input[type=text][name="litemf[city]"]').val($('input[type=text][name="payment_address[city]"]').val());
								}
								if($('input[type=text][name="litemf[region]"]').val() == '' && $('#shipping_address_zone_id option:selected').text() != '') {
									$('input[type=text][name="litemf[region]"]').val($('#shipping_address_zone_id option:selected').text());
								} else if($('input[type=text][name="litemf[region]"]').val() == '' && $('#payment_address_zone_id option:selected').text() != '') {
									$('input[type=text][name="litemf[region]"]').val($('#payment_address_zone_id option:selected').text());
								}
								if($('input[type=text][name="litemf[phone]"]').val() == '') {
									$('input[type=text][name="litemf[phone]"]').val($('input[type=tel][name="customer[telephone]"]').val());
								}
								if($('input[type=text][name="litemf[zip_code]"]').val() == '' && $('input[type=text][name="shipping_address[postcode]"]').val() == '' && $('input[type=text][name="shipping_address[postcode]"]').val() != undefined) {
									$('input[type=text][name="litemf[zip_code]"]').val($('input[type=text][name="shipping_address[postcode]"]').val());
								} else if($('input[type=text][name="litemf[zip_code]"]').val() == '' && $('input[type=text][name="payment_address[postcode]"]').val() != '') {
									$('input[type=text][name="litemf[zip_code]"]').val($('input[type=text][name="payment_address[postcode]"]').val());
								}
								$('#shiptor_delivery_block').show();
								$('input[type=hidden][name="litemf[delivery_method_id]"]').val($('input[name="shipping_method"]:checked').data('id'));
								if ($('input[name="shipping_method"]:checked').data('category') == 'courier') {
									$('#point-select').hide();
									$('#courier-price').find('input').prop("checked", true);
									$('input[type=hidden][name="litemf[delivery_point_id]"]').val('courier');
									$('#courier-field').show();
									$('#point-select').hide();
									$('#YMapsID').hide();
								}
								if ($('input[name="shipping_method"]:checked').data('category') == 'terminal') {
									if($('input[type=text][name="litemf[city]"]').val() != '') {
										getDeliveryPoints($('input[type=text][name="litemf[city]"]').val(), $('input[name="shipping_method"]:checked').data('id'));
									}
									$('#point-select').show();
									$('#YMapsID').show();
									$('#courier-price').hide();
									$('#courier-field').hide();
								}
							} else {
								$('#shiptor_delivery_block').hide();
							}
						}
					};
				  $.ajax({
					url: 'index.php?route=checkout/litemf/getDeliveryMethod',
					dataType: 'json',
					success: function (json) {
					  console.log(json)
					  $.each(json.result.data, function( index, value ) {
					  	 $.each(shippingMethods, function() {
							  var explodedMethod = this.value.split('.');
							  if (explodedMethod[0] == 'litemf_delivery') {
								  var explodedMethodId = explodedMethod[1].split('_');
								  if (explodedMethodId[2] == value.id) {
									  $(this).attr('data-category', value.delivery_type);
									  $(this).attr('data-id', value.id);
								  }
							  }
						  });
					  });
					  shippingMethods.change(function() {
						  if ($(this).is(":checked")) {
							  showBlockShiptor();
						  }
					  });
					  showBlockShiptor();
					},
					error: function (xhr, ajaxOptions, thrownError) {
					  alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
					}
				  });

			  $(document).ready(function() {
				$('#point-select').on('change', 'input[type=radio][name=point]', function() {
					if ($(this).data('point-id') != 'courier') {
						$('input[type=hidden][name="litemf[delivery_point_id]"]').val($(this).data('point-id'))
					}
				});
				$('#check_passport').change(function() {
					if ( $('#check_passport').is( ":checked" ) ) {
						$('#litemf_passport').show()
					} else {
						$('#litemf_passport').hide();
					}
				});
			  });
              function getDeliveryPoints(city, id){
				  	$.ajax({
						url: 'index.php?route=checkout/litemf/getDeliveryPoints&city=' + city + '&id=' + id,
						dataType: 'json',
						beforeSend: function() {
							 $('#loader').show();
						},
						complete: function(){
							 $('#loader').hide();
						 },
						success: function (json) {
							<?php if (isset($litemf)) { ?>
								var deliveryPointId = '<?php echo $litemf['delivery_point_id']; ?>';
							<?php } else { ?>;
								var deliveryPointId = '';
							<?php } ?>;
						    $('#point-select').text('');
						    destroyMap();
						    createMap();
						    var myGeocoder = ymaps.geocode(city, {results: 1});
							myGeocoder.then(function (res) {
				    			var firstGeoObject = res.geoObjects.get(0);
								coords = firstGeoObject.geometry.getCoordinates();
								console.log(coords[0]);
				  				setTown(coords[0], coords[1]);
				  				$.each(json, function( index, value ) {
				  					var checked = '';
				  					if (deliveryPointId == value.id) {
										checked = 'checked';
									}
									do_search(value);
									var gps = value.gps.split(',');
									var text = '<div class="list-group-item" style="padding-left:25px;">';
										  text += '<h4 class="list-group-item-heading"><input type="radio" name="point" value="' + value.cost + '" data-point-id="' + value.id + '" id="pvz_label_' + value.id + '" onClick="return go_to('+gps[0]+', '+gps[1]+',\''+value.name+'\');" ' + checked + '><span class="badge">Цена: ' + value.price + '</span> ' + value.name + '</h4>';
										  text += '<span>' + value.phone + '</span>';
										  text += '<p class="list-group-item-text">' + value.address + '</p>';
										  text += '<p class="list-group-item-text">' + value.work_schedule + '</p></div>';
									$('#point-select').append(text);
									$('#point-select').show();
									$('#YMapsID').show();
								});
							});
						},
						error: function (xhr, ajaxOptions, thrownError) {
						  alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
						}
						});
				  }
			</script>
			<script type="text/javascript">
				var map;
				var myCollection;
				function createMap() {
					ymaps.ready(function () {
						map = new ymaps.Map('YMapsID', {
							center: [55.7336, 37.581559],
							zoom: 7,
							type: 'yandex#map',
							behaviors: ['default', 'scrollZoom']
						});
						//Добавляем элементы управления
						map.controls
								.add('zoomControl')
								.add('typeSelector')
								.add('mapTools');
						myCollection = new ymaps.GeoObjectCollection();
					});
				}

                function do_search(item){
                		var gps = item.gps.split(',');
						var placemark = new ymaps.Placemark([gps[0],gps[1]], {
							//iconContent: item.id,
							balloonContentHeader: '<div>'+item.name+'</div>'
							/*balloonContentBody: '<div style="font-size:13px;"><div><strong>Адрес:</strong> '+item.address+'<br>'
							+'<strong>Стоимость доставки:</strong> '+item.price+'<br>'
							+'<strong>Режим работы:</strong> '+item.work_schedule+'<br>'
							+'<strong>Телефон:</strong> '+item.phone+'<br>'
							+'<strong>Описание:</strong> '+item.trip_description+'<br></div></div>'*/

						}, {
							// Опции
							preset: "islands#blueCircleDotIcon",
                    		iconColor: '#1faee9',
                    		balloonCloseButton: false,
                    		hideIconOnBalloonOpen: false
						});
						placemark.events.add('click', function(e) {
							var label = $('#pvz_label_' + item.id);
							label.prop("checked", true);
							$('#point-select').scrollTo(label.parents('.list-group-item'), 300);
						});
						myCollection.add(placemark);
                        map.geoObjects.add(myCollection);
                        map.setBounds(myCollection.getBounds());
                        map.setZoom(12, {checkZoomRange: true});
                }


                function go_to(iwslat,iwslon,iwsadr){
                    map.setCenter([iwslon,iwslat], 12);

                    myCollection.each(function (item) {
                        if (item.properties.get('balloonContentHeader') == '<div>'+iwsadr+'</div>') {
                            item.balloon.open();
                        }
                    });
                }

                function setTown(iwslat,iwslon){
                    map.setCenter([iwslat, iwslon], 11);
                    myCollection.removeAll();
                    return false;
                }
                function destroyMap(){
                	if($.type(map) === "object") {
                		map.destroy();
                	}
				}
				</script>
			]]></add>
		</operation>
	</file>
	<file path="catalog/controller/checkout/simplecheckout.php">
		<operation error="skip">
			<search><![CDATA[$this->session->data['order_id'] = $order_id;]]></search>
			<add position="after"><![CDATA[
				if (isset($data['shipping_code']) && !empty($this->session->data['litemf'])) {
					$shiptorMethod =  explode(".", $data['shipping_code']);
					if ($shiptorMethod[0] == 'litemf_delivery') {
						$litemf_data = [];
						if(!empty($this->request->post['point'])) {
							$value['value'] = round($this->request->post['point'],2);
						}
						if(!empty($this->session->data['order_id'])) {
						    $litemf_data['order_id'] = $this->session->data['order_id'];
						}
						if(!empty($this->session->data['litemf'])) {
						    $litemf_data['passport'] = $this->session->data['litemf'];
						}
						$litemf_data['user_id'] = $data['customer_id'];
						if (isset($this->session->data['courier'])) {
							$litemf_data['courier'] = $this->session->data['courier'];
						}
						$this->load->model('shipping/litemf_delivery');
						$this->model_shipping_litemf_delivery->addOrderLitemf($litemf_data);
					}
				}
			]]></add>
		</operation>
		<operation error="skip">
			<search><![CDATA[foreach ($totals as $key => $value) {]]></search>
			<add position="after"><![CDATA[
				if (isset($this->session->data['shipping_method'])) {
					$shiptorMethod =  explode(".", $this->session->data['shipping_method']['code']);
					if ($shiptorMethod[0] == 'litemf_delivery' && $value['code'] == 'shipping' && !empty($this->request->post['point'])) {
						$totals[$key]['value']= round($this->request->post['point'],2);
					}
					if ($shiptorMethod[0] == 'litemf_delivery' && $value['code'] == 'total' && !empty($this->request->post['point'])) {
						$totals[$key] = $value['value'] + round($this->request->post['point'],2);
					}
				}
			]]></add>
		</operation>
	</file>
	<file path="catalog/controller/checkout/simplecheckout_cart.php">
		<operation error="skip">
			<search><![CDATA[$sort_order[$key] = $value['sort_order'];]]></search>
			<add position="after"><![CDATA[
				if (isset($this->session->data['shipping_method'])) {
					$shiptorMethod =  explode(".", $this->session->data['shipping_method']['code']);
					if ($shiptorMethod[0] == 'litemf_delivery' && $value['code'] == 'shipping') {
						if(!empty($this->request->post['point'])) {
							$value['value'] = round($this->request->post['point'],2);
						}
						if(!empty($this->request->post['litemf'])) {
						    $this->session->data['litemf'] = $this->request->post['litemf'];
						}
						if(!empty($this->request->post['courier'])) {
						    $this->session->data['courier'] = $this->request->post['courier'];
						}
						if (isset($this->request->post['courier'])) {
							$this->session->data['courier'] = $this->request->post['courier'];
						}
					}
					if ($shiptorMethod[0] == 'litemf_delivery' && $value['code'] == 'total' && !empty($this->request->post['point'])) {
						$value['value'] = $value['value'] + round($this->request->post['point'],2);
					}
                }
			]]></add>
		</operation>
	</file>
	<file path="catalog/controller/checkout/simplecheckout_shipping.php">
		<operation error="skip">
			<search><![CDATA[if ($this->request->server['REQUEST_METHOD'] == 'POST' && !empty($this->request->post['shipping_method_checked'])) {]]></search>
			<add position="after"><![CDATA[
				if (isset($this->request->post['litemf'])) {
					$this->_templateData['litemf'] = $this->request->post['litemf'];
				}
				if (isset($this->request->post['courier'])) {
					$this->_templateData['courier'] = $this->request->post['courier'];
				}
			]]></add>
		</operation>
	</file>
	<file path="catalog/view/javascript/simplecheckout.js">
		<operation>
			<search><![CDATA[if (!checkIsInContainer($(this), self.selectors.paymentForm)) {]]></search>
			<add position="replace"><![CDATA[
				if (!checkIsInContainer($(this), self.selectors.paymentForm) && $(this).attr("name") != 'method_id' && $(this).attr("name") != 'litemf[passport]' ) {
			]]></add>
		</operation>
	</file>
	<file path="catalog/view/theme/*/template/payment/cod.tpl">
		<operation>
			<search><![CDATA[$('#button-confirm').on('click', function() {]]></search>
			<add position="after"><![CDATA[
				if ( $('#check_passport').is( ":checked" )) {
					var inputs = $('input[name*="litemf"]');
					var status = true;
					$.each(inputs, function( index, value ) {
						var pattern = new RegExp(value.getAttribute( 'pattern' ));
						if (value.getAttribute( 'pattern' ) != null) {
							var result = pattern.test(value.value);
							$(value).parent().find('.text-danger').remove();
							if (!result) {
								$(value).parent().append('<div class="text-danger">' + $(value).data('error') + '</div>');
								status = false
							}
						}

					});
					if (!status) {
						return false;
					}
				}
				if ($('#method-courier').is( ":checked" )) {
					var inputCourier = $('input[name*="courier"]');
					var statusCourier = true;
					$.each(inputCourier, function( index, value ) {
						var pattern = new RegExp(value.getAttribute( 'pattern' ));
						if (value.getAttribute( 'pattern' ) != null) {
							var result = pattern.test(value.value);
							$(value).parent().find('.text-danger').remove();
							if (!result) {
								$(value).parent().append('<div class="text-danger">' + $(value).data('error') + '</div>');
								statusCourier = false
							}
						}
					});
					if (!statusCourier) {
						return false;
					}
				}
			]]></add>
		</operation>
	</file>
</modification>